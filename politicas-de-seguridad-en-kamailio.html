<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


  <title>Politicas de seguridad en Kamailio</title>


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
  <link href="https://acalustra.com/" rel="canonical" />

  <!-- Feed -->
        <link href="https://acalustra.com/rss.xml" type="application/atom+xml" rel="alternate" title="A Calustra Full Atom Feed" />

  <link href="https://acalustra.com/theme/css/style.css" type="text/css" rel="stylesheet" />

  <!-- Code highlight color scheme -->
      <link href="https://acalustra.com/theme/css/code_blocks/github.css" rel="stylesheet">


  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->


  <link href="https://acalustra.com/politicas-de-seguridad-en-kamailio.html" rel="canonical" />
  <meta name="keywords" content="kamailio, python, redis, seguridad, voip, pike" >

    <meta name="description" content="El otro día a través de este tuit de Elio Rojano me anime a documentar una serie de procesos que estamos siguiendo para mantener nuestra...">

    <meta name="author" content="eloycoto">

    <meta name="tags" content="kamailio">
    <meta name="tags" content="redis">
    <meta name="tags" content="python">
    <meta name="tags" content="seguridad">
    <meta name="tags" content="ataques">
    <meta name="tags" content="voip">
    <meta name="tags" content="sip">




<!-- Open Graph -->
<meta property="og:site_name" content="A Calustra"/>
<meta property="og:title" content="Politicas de seguridad en Kamailio"/>
<meta property="og:description" content="El otro día a través de este tuit de Elio Rojano me anime a documentar una serie de procesos que estamos siguiendo para mantener nuestra..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://acalustra.com/politicas-de-seguridad-en-kamailio.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2014-04-05 12:20:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://acalustra.com/author/eloycoto.html">
<meta property="article:section" content="blog"/>
<meta property="article:tag" content="kamailio"/>
<meta property="article:tag" content="redis"/>
<meta property="article:tag" content="python"/>
<meta property="article:tag" content="seguridad"/>
<meta property="article:tag" content="ataques"/>
<meta property="article:tag" content="voip"/>
<meta property="article:tag" content="sip"/>
<meta property="og:image" content="https://acalustra.com/img/oia.jpg">

<!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@eloycoto">
    <meta name="twitter:title" content="Politicas de seguridad en Kamailio">
    <meta name="twitter:url" content="https://acalustra.com/politicas-de-seguridad-en-kamailio.html">

        <meta name="twitter:image:src" content="https://acalustra.com/img/oia.jpg">

      <meta name="twitter:description" content="El otro día a través de este tuit de Elio Rojano me anime a documentar una serie de procesos que estamos siguiendo para mantener nuestra...">

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Politicas de seguridad en Kamailio",
  "headline": "Politicas de seguridad en Kamailio",
  "datePublished": "2014-04-05 12:20:00+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "eloycoto",
    "url": "https://acalustra.com/author/eloycoto.html"
  },
  "image": "https://acalustra.com/img/oia.jpg",
  "url": "https://acalustra.com/politicas-de-seguridad-en-kamailio.html",
  "description": "El otro día a través de este tuit de Elio Rojano me anime a documentar una serie de procesos que estamos siguiendo para mantener nuestra..."
}
</script>
</head>
<!-- TODO : Body class -->
<body class="home-template">

<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <ul>

              <li role="presentation"><a href="https://acalustra.com/pages/about.html">About</a></li>

    </ul>
  </div>
</nav>
    <!-- Progressbar -->
    <div class="progress-container">
        <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header id="post-header" class="has-cover">
      <div class="inner">
        <nav id="navigation">
            <span id="home-button" class="nav-button">
                <a class="home-button" href="https://acalustra.com/" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
            </span>
          <span id="menu-button" class="nav-button">
            <a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
          </span>
        </nav>
        <h1 class="post-title">Politicas de seguridad en Kamailio</h1>
        <!-- TODO : Proper class for headline -->
        <span class="post-meta">
                <a href="https://acalustra.com/author/eloycoto.html">Eloy Coto</a>
            | <time datetime="Saturday 05-04-2014">Saturday 05-04-2014</time>
        </span>
        <!-- TODO : Modified check -->
            <div class="post-cover cover" style="background-image: url('https://acalustra.com/img/oia.jpg')">
      </div>
    </header>

  <section id="wrapper">
    <a class="hidden-close"></a>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
            <section class="post-content">
                <p>El otro día a través de este <a class="reference external" href="https://twitter.com/hellc2/status/448756126382034944">tuit de Elio Rojano</a> me anime a  documentar una serie de procesos que estamos siguiendo para mantener nuestra infraestructura segura y al mismo tiempo poder mantener las excepciones para no cortar el servicio en falsos positivos.</p>
<p>Para securizar kamailio lo más normal es usar el <a class="reference external" href="http://kamailio.org/docs/modules/stable/modules/pike.html">módulo pike</a>, teniendo un código muy parecido a este tipo:</p>
<pre class="literal-block">
route[PIKE_CHECK]{
    if (src_ip == myself)
        return(1);

    if($sht(ipban=&gt;$si)!=$null){
        xdbg(&quot;Request $rm from blocked IP - from $fu (IP:$si:$sp)\n&quot;);
        exit;
    }

    if (!pike_check_req()){
        xlog(&quot;L_ALERT&quot;,&quot;Callid $ci -- pike blocking $rm from $fu (IP:$si:$sp)&quot;);
        $sht(ipban=&gt;$si) = 1;
        exit;
    }
}
</pre>
<p>Pero esto según los parámetros del modelo  podemos poner más rígido o más flexible. Si le pones flexible puedes poner en riesgo tu infraestructura. Nosotros creemos que la mejor opción es ser restrictivos y añadir opciones para desbloquear.</p>
<p>En nuestro caso a la ruta normal de Pike hemos añadido una serie de valores que nos son útiles para añadir datos a la blacklist:</p>
<ul class="simple">
<li>Validar si la extensión se parece a una existente.El caso de que se registre a la extensión 140 cuando lo normal es tener extensiones 7XXX, por otro lado para extensiones con nombre vamos a usar el <a class="reference external" href="https://github.com/seatgeek/fuzzywuzzy">método fuzzy</a>.</li>
<li>Validar una lista blanca de IPs que siempre están validadas.</li>
<li>En caso de error tenemos una cola que obtiene el valor del <a class="reference external" href="http://stackoverflow.com/questions/2575760/python-lookup-hostname-from-ip-with-1-second-timeout">reverse dns</a> de la ip origen, si no pertenece a un dominio válido no bloqueamos.</li>
</ul>
<p>Por otra parte muchos de nuestros clientes se conectan desde ips de hoteles/starbucks/etc. Es bastante difícil de explicar que se te bloquea desde un determinado lugar por tener problemas con el registro de su sip. Básicamente hemos añadido una opción dentro del userportal, que valida la ip como usuario y añade durante una hora la ip en la whitelist. Para hacerlo tenemos la siguiente route:</p>
<pre class="literal-block">
modparam(&quot;ndb_redis&quot;, &quot;server&quot;, &quot;name=srvN;addr=127.0.0.1;port=6379;db=0&quot;)
route[IS_IN_WHITE_LIST]{
    if ( redis_cmd(&quot;srvN&quot;,&quot;GET white_list:$si&quot;,&quot;r&quot;) ){
        return(1);
    }else{
        return(0);
    }
}
</pre>
<p>Desde nuestra web básicamente hacemos los siguientes comandos dentro de redis:</p>
<pre class="literal-block">
redis 127.0.0.1:6379&gt; SET white_list:{SOURCE_IP} 1
OK
redis 127.0.0.1:6379&gt; EXPIRE white_list:{SOURCE_IP} 3600
(integer) 1
</pre>
<p>Con esto de momento y teniendo muy en cuenta la información del graphite vamos intentando solucionar todos nuestros problemas. Nuestra white list es accesible desde diferentes puntos, desde la integración con la web nuestros clientes están más contentos y al mismo tiempo en cualquier momento podemos bloquear a una IP.</p>
<p>Por otra parte tenemos nuestro sistema de bloqueo por rates, en el momento que un cliente se dispara de rates en un momento, lo que hacemos es borrarlo de la white_list y volvemos a bloquearlo. Por otra parte estamos buscando una manera de añadir un counter con expire, para ver que una ip no hace 100 request en 5 minutos, pero esto, de momento, es una idea.</p>
<p>Esto, evidentemente, no es el mejor sistema de seguridad, un robot puede llegar a acceder a la url del sistema, pero bueno, al mismo tiempo intentamos que nuestros problemas no sean problemas de nuestros clientes ;-)</p>
<p>PS: Desde la pasada Kamailio World conference el siguiente punto será este usar los datos de <a class="reference external" href="http://mirror.simwood.com/honeypot/">Ips de Simwood</a></p>

            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=Politicas de seguridad en Kamailio&amp;url=https://acalustra.com/politicas-de-seguridad-en-kamailio.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://acalustra.com/politicas-de-seguridad-en-kamailio.html" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
                    </a>
                    <a class="googleplus" href="https://plus.google.com/share?url=https://acalustra.com/politicas-de-seguridad-en-kamailio.html" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <i class="ic ic-googleplus"></i><span class="hidden">Google+</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="https://acalustra.com/tag/kamailio.html">kamailio</a><a href="https://acalustra.com/tag/redis.html">redis</a><a href="https://acalustra.com/tag/python.html">python</a><a href="https://acalustra.com/tag/seguridad.html">seguridad</a><a href="https://acalustra.com/tag/ataques.html">ataques</a><a href="https://acalustra.com/tag/voip.html">voip</a><a href="https://acalustra.com/tag/sip.html">sip</a>                </aside>

                <div class="clear"></div>

                <aside class="post-author">


                        <figure class="post-author-avatar">
                            <img src="https://acalustra.com/img/profile.jpg" alt="Eloy Coto" />
                        </figure>
                    <div class="post-author-bio">
                        <h4 class="post-author-name"><a href="https://acalustra.com/author/eloycoto.html">Eloy Coto</a></h4>
                            <p class="post-author-about">Senior software engineer with experience in Golang, C and Python and CI/CD</p>
                            <span class="post-author-location"><i class="ic ic-location"></i> Galicia</span>
                            <span class="post-author-website"><a href="http://acalustra.com"><i class="ic ic-link"></i> Website</a></span>
                        <!-- Social linkes in alphabet order. -->
                            <span class="post-author-github"><a target="_blank" href="https://github.com/eloycoto"><i class="ic ic-link"></i> GitHub</a></span>
                            <span class="post-author-linkedin"><a target="_blank" href="https://www.linkedin.com/in/eloycoto"><i class="ic ic-link"></i> LinkedIn</a></span>
                            <span class="post-author-twitter"><a target="_blank" href="https://twitter.com/eloycoto"><i class="ic ic-twitter"></i> Twitter</a></span>
                    </div>
                    <div class="clear"></div>
                </aside>

                </section>

                <script type="text/javascript">
                    var disqus = 'acalustra';
                    var disqus_shortname = 'acalustra';
                    var disqus_identifier = '/politicas-de-seguridad-en-kamailio.html';
                    var disqus_url = 'https://acalustra.com/politicas-de-seguridad-en-kamailio.html';
                </script>
                <noscript>Please enable JavaScript to view the comments.</noscript>
                <section class="post-comments">
                        <a id="show-disqus" class="post-comments-activate" data-disqus-identifier="/politicas-de-seguridad-en-kamailio.html" >Show Comments</a>
                    <div id="disqus_thread"></div>
                </section>

                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
      <!-- TODO : Body class -->
    <div id="body-class" style="display: none;" class=""></div>

    <footer id="footer">
      <div class="inner">
        <section class="credits">


          <span class="credits-theme">Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a></span>
          <span class="credits-software">Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a></span>
        </section>
      </div>
    </footer>
  </section>

  <script type="text/javascript" src="https://acalustra.com/theme/js/script.js"></script>

    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-36310774-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-36310774-1', { 'anonymize_ip': true });
    </script>
<script type="text/javascript">
    var disqus_shortname = 'acalustra';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>