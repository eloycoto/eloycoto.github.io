<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title> Apply terraform plans with validation using Jenkins Pipeline</title>
    <link rel="canonical" href="https://acalustra.com/using-jenkins-pipelines-to-deploy-terraform.html" />
    <meta name="keywords" content=" terraform, jenkins, pipelines, packer, devops"/>
    <meta name="description" content=" Jenkins 2.0 introduced pipelines, this feature is too useful to apply terraform plans without trouble. "/>

    <link rel="stylesheet" type="text/css" href="/theme/css/style.css">
    <link rel="stylesheet" type="text/css" href="/theme/css/pygment.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://acalustra.com/rss.xml" type="application/atom+xml" rel="alternate" title="A Calustra Full Atom Feed" />







    <meta name="tags" content="jenkins, terraform, pipelines, devops, packer, hashicorp" />
    <meta name="date" content=" 2016-07-05 10:00:00+02:00" />
    <meta name="category" content="blog" />
    <meta name="author" content="Eloy coto" />
    <meta name="robots" content="index,follow" />
  </head>
  <body>

    <header>
      <b> A Calustra - Eloy Coto Pereiro </b>
      <a href="/">Home</a>
      <!-- <a href="/blog">Blog</a> -->
      <a href="/pages/about.html">About</a>
    </header>

<article>
  <h1 itemprop="name headline">Jenkins Pipeline to apply terraform plans</h1>
  <p>
    <b rel="author">Eloy Coto Pereiro </b>
    on
    <time datetime="2016-07-05T10:00:00" itemprop="datePublished">July 05th, 2016</time>
  </p>


  <div itemprop="articleBody">
    <p><a class="reference external" href="https://jenkins.io/2.0/">Jenkins 2.0</a> was released a few weeks ago. One of
the main problems that I use to had in Jenkins was multi-stages jobs, there was
a plugin from Cloudbees but it was difficult to use. This new version
<a class="reference external" href="https://jenkins.io/doc/pipeline/jenkinsfile/">implements pipelines based on a Jenkinsfile</a> in the root of the project.
This is easier, quicker and in one word: <strong>awesome</strong>.</p>
<p>So, in jenkins 2.0 &quot;stages&quot; can be described in the Jenkinsfile. Stage can be
explained as the different status that a job need to have. In a typical web
application the stages will be the following:</p>
<ul class="simple">
<li><strong>test</strong>: Run in parallel unittest and integration test.</li>
<li><strong>artifact</strong>: Compile the source</li>
<li><strong>Staging</strong>: to update your staging platform</li>
<li><strong>Prod</strong>: Update your prod infraestructure.</li>
</ul>
<p>A very simple multi-stage Jenkinsfile looks like this:</p>
<div class="highlight"><pre><span></span>node <span class="o">{</span>
    stage <span class="s1">&#39;Stage 1&#39;</span>
       <span class="nb">echo</span> <span class="s1">&#39;Hello World 1&#39;</span>
    stage <span class="s1">&#39;Stage 2&#39;</span>
       <span class="nb">echo</span> <span class="s1">&#39;Hello World 2&#39;</span>
    stage <span class="s1">&#39;Stage 3&#39;</span>
       <span class="nb">echo</span> <span class="s1">&#39;Hello World 3&#39;</span>
    stage <span class="s1">&#39;Stage 4&#39;</span>
       <span class="nb">echo</span> <span class="s1">&#39;Hello World 4&#39;</span>
<span class="o">}</span>
</pre></div>
<p>And you're going to have a lovely dashboard like this:</p>
<img alt="Jenkins pipeline example" class="align-center" src="img/jenkins_pipeline_stage_example.png" />
<p>Checkout, run test and compile the artifacts can be done in the past without
pipelines, but what about the deploys? It was possible, but human integration
was added in pipelines and the solution is great for tools like Terraform.</p>
<p>Review a plan is one of the best features of <a class="reference external" href="https://www.hashicorp.com/atlas.html">Hashicorp Atlas</a>. An engineer will always be sure that
the plan will be applied correctly using <a class="reference external" href="https://www.terraform.io/">terraform</a>.  Now this can be possible with a few lines of
code:</p>
<div class="highlight"><pre><span></span>node <span class="o">{</span>
   stage <span class="s1">&#39;checkout&#39;</span>
        checkout scm

   stage <span class="s1">&#39;test&#39;</span>
        parallel <span class="o">(</span>
            phase1: <span class="o">{</span> sh <span class="s2">&quot;echo p1; sleep 20s; echo phase1&quot;</span> <span class="o">}</span>,
            phase2: <span class="o">{</span> sh <span class="s2">&quot;echo p2; sleep 40s; echo phase2&quot;</span> <span class="o">}</span>
        <span class="o">)</span>
   stage name: <span class="s1">&#39;build&#39;</span>, concurrency: <span class="m">1</span>
        sh <span class="s2">&quot;packer build project.json&quot;</span>

   stage name: <span class="s1">&#39;plan&#39;</span>, concurrency: <span class="m">1</span>
        sh <span class="s2">&quot;terraform plan --out plan&quot;</span>

   stage name: <span class="s1">&#39;deploy&#39;</span>, concurrency: <span class="m">1</span>
        def <span class="nv">deploy_validation</span> <span class="o">=</span> input<span class="o">(</span>
            id: <span class="s1">&#39;Deploy&#39;</span>,
            message: <span class="s1">&#39;Let\&#39;</span>s <span class="k">continue</span> the deploy plan<span class="err">&#39;</span>,
            type: <span class="s2">&quot;boolean&quot;</span><span class="o">)</span>

        sh <span class="s2">&quot;terraform apply plan&quot;</span>
<span class="o">}</span>
</pre></div>
<img alt="Jenkins Terraform pipeline" class="align-center" src="img/jenkis_terraform.png" />
<p>With this code you can easy review changes that terraform will make and deploy
your infrastructure with the right human interaction. This code is too
simplified but you can do all the business logic that you want. Complete list of
examples can be found in <a class="reference external" href="https://github.com/jenkinsci/pipeline-examples/tree/master/pipeline-examples">github</a>.</p>
<img alt="Jenkins pipeline terraform plan" class="align-center" src="img/jenkis_terraform_plan.png" />
<p>From my point of view this is a big step forward for continuous delivery, I
always miss a tool that I can make pipelines into our organization. From now all
my fellows can see in what state is each build. In the other hand, <a class="reference external" href="https://www.cloudbees.com/">Cloudbees</a> is working in a new UI, <a class="reference external" href="https://jenkins.io/blog/2016/05/26/introducing-blue-ocean/">blueocean</a>, it is great and
it'll make even simpler to review it.</p>
<p>Related with the Jenkinsfile DSL reference, <a class="reference external" href="https://jenkins.io/blog/2016/05/26/introducing-blue-ocean/">Cloudbees wrote</a> a complete blog
post with all commands. Furthermore full pipelines <a class="reference external" href="https://jenkins.io/solutions/pipeline/">documentation</a> can be found in jenkins webpage.</p>


    <h3>Tags</h3>
    <div class="taglist">
        <span class="tag">
          <a href="/tag/jenkins.html" rel="tag">jenkins</a>
        </span>
        <span class="tag">
          <a href="/tag/packer.html" rel="tag">packer</a>
        </span>
        <span class="tag">
          <a href="/tag/terraform.html" rel="tag">terraform</a>
        </span>
    </div><!--tags-->

    <h4>Related articles:</h4>
      <ul>
          <li><a href="/voip-talk-at-librecon-2015.html">Voip talk at Librecon 2015</a></li>
          <li><a href="/terraform-recipes-to-test-cilium-on-kubernetes.html">Terraform recipes to test Cilium on Kubernetes</a></li>
          <li><a href="/my-review-of-hashiconf-europe-16.html">My review of Hashiconf Europe 16</a></li>
          <li><a href="/jenkins-slides-from-my-vigojug-meetup.html">Jenkins Slides from my VigoJug meetup</a></li>
      </ul>

  </div>
</article></body>