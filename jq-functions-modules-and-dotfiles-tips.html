<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title> JQ functions, modules and dotfiles tips</title>
    <link rel="canonical" href="https://acalustra.com/jq-functions-modules-and-dotfiles-tips.html" />
    <meta name="keywords" content=" jq, kubernetes, jqterm, cilium"/>
    <meta name="description" content=" This is an example about how to use a JQ modules "/>

    <link rel="stylesheet" type="text/css" href="/theme/css/style.css">
    <link rel="stylesheet" type="text/css" href="/theme/css/pygment.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://acalustra.com/rss.xml" type="application/atom+xml" rel="alternate" title="A Calustra Full Atom Feed" />







    <meta name="tags" content="jq, kubernetes, cilium" />
    <meta name="date" content=" 2019-02-02 15:01:01+01:00" />
    <meta name="category" content="blog" />
    <meta name="author" content="Eloy coto" />
    <meta name="robots" content="index,follow" />
  </head>
  <body>

    <header>
      <b> A Calustra - Eloy Coto Pereiro </b>
      <a href="/">Home</a>
      <!-- <a href="/blog">Blog</a> -->
      <a href="/pages/about.html">About</a>
    </header>

<article>
  <h1 itemprop="name headline">JQ functions, modules and dotfiles</h1>
  <p>
    <b rel="author">Eloy Coto Pereiro </b>
    on
    <time datetime="2019-02-02T15:01:01" itemprop="datePublished">February 02th, 2019</time>
  </p>


  <div itemprop="articleBody">
    <p>Over the last months I’m using quite a lot <a class="reference external" href="https://stedolan.github.io/jq/manual/#DefiningFunctions">JQ</a> custom functions and
<a class="reference external" href="https://stedolan.github.io/jq/manual/#Modules">modules</a>, If you need to deal
with the same JSON multiples times, maybe you need to dump this information
easily human-readable format.</p>
<p>Due to my work on top of <a class="reference external" href="https://kubernetes.io/">Kubernetes</a>, I need to deal
with a lot of offline Kubernetes data, to debug issues from test results or
users environment, this means that I need to query the same JSON schema multiple
times, I also want to make my work faster, and here is where JQ plays a
remarkable role.</p>
<p>For example, if you have the list of Kubernetes Pods in JSON (<tt class="docutils literal">kubectl get pods <span class="pre">-o</span> json</tt>) and you want to know if all  containers are ready for each pod, the
JQ query look like this:</p>
<div class="highlight"><pre><span></span>kubectl get pods -n kube-system -o json <span class="p">|</span> jq <span class="se">\</span>
<span class="s1">&#39;.items[]|[ (.metadata.namespace+&quot;:&quot;+.metadata.name), ([.status.containerStatuses[].ready]|all)]&#39;</span>
<span class="o">[</span>
  <span class="s2">&quot;default:app1-6f995955d9-7m8qr&quot;</span>,
  <span class="nb">false</span>
<span class="o">]</span>
<span class="o">[</span>
  <span class="s2">&quot;default:app1-6f995955d9-q9zxf&quot;</span>,
  <span class="nb">false</span>
<span class="o">]</span>
<span class="o">[</span>
  <span class="s2">&quot;default:app2-5b49d5dd9-fsmlf&quot;</span>,
  <span class="nb">false</span>
<span class="o">]</span>
<span class="o">[</span>
  <span class="s2">&quot;default:app3-645549cb84-f4phh&quot;</span>,
  <span class="nb">false</span>
<span class="o">]</span>
</pre></div>
<p>This query is simple, but also is hard to remember, and finally, the next time
that you need to use that, you will try, at least few times, before you get the
desired result.</p>
<p>JQ have the possibility to define functions, so that query can be translated to
a function, for example:</p>
<div class="highlight"><pre><span></span>kubectl get pods -o json <span class="p">|</span> jq <span class="se">\</span>
   <span class="s1">&#39;def container_status: .items[]|[(.metadata.namespace+&quot;:&quot;+.metadata.name),([.status.containerStatuses[].ready]|all)]; container_status&#39;</span>
</pre></div>
<p>Is getting better, now you can write that function into ~/.jq where JQ is
looking for, and container status query is getting super simple:</p>
<div class="highlight"><pre><span></span>kubectl get pods -o json <span class="p">|</span> jq <span class="s1">&#39;container_status&#39;</span>
<span class="o">[</span>
  <span class="s2">&quot;default:app1-6f995955d9-7m8qr&quot;</span>,
  <span class="nb">false</span>
<span class="o">]</span>
<span class="o">[</span>
  <span class="s2">&quot;default:app1-6f995955d9-q9zxf&quot;</span>,
  <span class="nb">false</span>
<span class="o">]</span>
<span class="o">[</span>
  <span class="s2">&quot;default:app2-5b49d5dd9-fsmlf&quot;</span>,
  <span class="nb">false</span>
<span class="o">]</span>
<span class="o">[</span>
  <span class="s2">&quot;default:app3-645549cb84-f4phh&quot;</span>,
  <span class="nb">false</span>
<span class="o">]</span>
</pre></div>
<p>This can be more legible than before, JSON perhaps is not the best format to
debug or quick lock, so jq output format can be used to make the output more
human-friendly, I’m a big fan of TSV format for shell, but also sh format is
good.</p>
<div class="highlight"><pre><span></span>$ cat ~/.jq
def container_status: .items<span class="o">[]</span><span class="p">|</span><span class="o">[(</span>.metadata.namespace+<span class="s2">&quot;:&quot;</span>+.metadata.name<span class="o">)</span>,<span class="o">([</span>.status.containerStatuses<span class="o">[]</span>.ready<span class="o">]</span><span class="p">|</span>all<span class="o">)]</span><span class="p">;</span>
</pre></div>
<div class="highlight"><pre><span></span>kubectl get pods -o json <span class="p">|</span> jq -r <span class="s1">&#39;container_status| @tsv&#39;</span>
<span class="s1">&#39;default:app1-6f995955d9-7m8qr&#39;</span> <span class="nb">false</span>
<span class="s1">&#39;default:app1-6f995955d9-q9zxf&#39;</span> <span class="nb">false</span>
<span class="s1">&#39;default:app2-5b49d5dd9-fsmlf&#39;</span> <span class="nb">false</span>
<span class="s1">&#39;default:app3-645549cb84-f4phh&#39;</span> <span class="nb">false</span>
</pre></div>
<div class="highlight"><pre><span></span>kubectl get pods -o json <span class="p">|</span> jq -r <span class="s1">&#39;container_status| sh&#39;</span>
default:app1-6f995955d9-7m8qr   <span class="nb">false</span>
default:app1-6f995955d9-q9zxf   <span class="nb">false</span>
default:app2-5b49d5dd9-fsmlf    <span class="nb">false</span>
default:app3-645549cb84-f4phh   <span class="nb">false</span>
</pre></div>
<p>TSV is nice when you use with column commands, you can make a pretty table in
seconds, I have the following alias/function to be more productive, so jq
queries over the same JSON files are much simpler.</p>
<div class="highlight"><pre><span></span><span class="k">function</span> jqr<span class="o">(){</span>
    jq -r <span class="nv">$1</span> <span class="p">|</span> column -t
<span class="o">}</span>

$ kubectl get pods -o json <span class="p">|</span> jqr <span class="s1">&#39;container_status|@tsv&#39;</span>
default:app1-6f995955d9-7m8qr  <span class="nb">false</span>
default:app1-6f995955d9-q9zxf  <span class="nb">false</span>
default:app2-5b49d5dd9-fsmlf   <span class="nb">false</span>
default:app3-645549cb84-f4phh  <span class="nb">false</span>
</pre></div>
<p>After a while, your queries will look more powerfull, and your life will be
easier.</p>
<div class="highlight"><pre><span></span>def cep_status:
    <span class="o">([</span><span class="s2">&quot;Name&quot;</span>, <span class="s2">&quot;EpID&quot;</span>,<span class="s2">&quot;IdID&quot;</span>, <span class="s2">&quot;Ingress&quot;</span>, <span class="s2">&quot;Egress&quot;</span>, <span class="s2">&quot;IPv4&quot;</span>, <span class="s2">&quot;IPv6&quot;</span><span class="o">])</span>, <span class="o">(</span>
    .items<span class="o">[]</span><span class="p">|</span><span class="o">[</span>.metadata.name, .status.id, .status.identity.id,
    .status.policy.ingress.enforcing,
    .status.policy.egress.enforcing,
    .status.networking.addressing<span class="o">[</span><span class="m">0</span><span class="o">]</span>.ipv4,
    .status.networking.addressing<span class="o">[</span><span class="m">0</span><span class="o">]</span>.ipv6<span class="o">])</span> <span class="p">|</span> @tsv<span class="p">;</span>
</pre></div>
<p>You can see all my examples <a class="reference external" href="https://github.com/eloycoto/dotfiles">here</a>, and here an example output that I use all
days:</p>
<img alt="JQ modules example" class="align-center" src="img/jq.png" />
<p>Hope you enjoy it!</p>


    <h3>Tags</h3>
    <div class="taglist">
        <span class="tag">
          <a href="/tag/jq.html" rel="tag">jq</a>
        </span>
        <span class="tag">
          <a href="/tag/kubernetes.html" rel="tag">kubernetes</a>
        </span>
    </div><!--tags-->

    <h4>Related articles:</h4>
      <ul>
          <li><a href="/kubernetes-network-policies-talk-at-atlanticaconf19.html">Kubernetes Network Policies talk at AtlanticaConf19</a></li>
          <li><a href="/terraform-recipes-to-test-cilium-on-kubernetes.html">Terraform recipes to test Cilium on Kubernetes</a></li>
      </ul>

  </div>
</article></body>