<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


  <title>trick and tips en ansible</title>


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
  <link href="https://acalustra.com/" rel="canonical" />

  <!-- Feed -->
        <link href="https://acalustra.com/rss.xml" type="application/atom+xml" rel="alternate" title="A Calustra Full Atom Feed" />

  <link href="https://acalustra.com/theme/css/style.css" type="text/css" rel="stylesheet" />

  <!-- Code highlight color scheme -->
      <link href="https://acalustra.com/theme/css/code_blocks/github.css" rel="stylesheet">


  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->


  <link href="https://acalustra.com/trick-and-tips-en-ansible.html" rel="canonical" />
  <meta name="keywords" content="ansible, playbooks, conditionals, tricks, trucos, python, asterisk" >

    <meta name="description" content="Hace aproximadamente dos años que empecé a trabajar con Ansible. Desde ese día después de usar algo de chef/puppet y darme cabezazos...">

    <meta name="author" content="eloycoto">

    <meta name="tags" content="ansible">
    <meta name="tags" content="devops">
    <meta name="tags" content="howto">
    <meta name="tags" content="asterisk">
    <meta name="tags" content="playbook">




<!-- Open Graph -->
<meta property="og:site_name" content="A Calustra"/>
<meta property="og:title" content="trick and tips en ansible"/>
<meta property="og:description" content="Hace aproximadamente dos años que empecé a trabajar con Ansible. Desde ese día después de usar algo de chef/puppet y darme cabezazos..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://acalustra.com/trick-and-tips-en-ansible.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2014-06-03 12:20:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://acalustra.com/author/eloycoto.html">
<meta property="article:section" content="blog"/>
<meta property="article:tag" content="ansible"/>
<meta property="article:tag" content="devops"/>
<meta property="article:tag" content="howto"/>
<meta property="article:tag" content="asterisk"/>
<meta property="article:tag" content="playbook"/>
<meta property="og:image" content="https://acalustra.com/img/oia.jpg">

<!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@eloycoto">
    <meta name="twitter:title" content="trick and tips en ansible">
    <meta name="twitter:url" content="https://acalustra.com/trick-and-tips-en-ansible.html">

        <meta name="twitter:image:src" content="https://acalustra.com/img/oia.jpg">

      <meta name="twitter:description" content="Hace aproximadamente dos años que empecé a trabajar con Ansible. Desde ese día después de usar algo de chef/puppet y darme cabezazos...">

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "trick and tips en ansible",
  "headline": "trick and tips en ansible",
  "datePublished": "2014-06-03 12:20:00+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "eloycoto",
    "url": "https://acalustra.com/author/eloycoto.html"
  },
  "image": "https://acalustra.com/img/oia.jpg",
  "url": "https://acalustra.com/trick-and-tips-en-ansible.html",
  "description": "Hace aproximadamente dos años que empecé a trabajar con Ansible. Desde ese día después de usar algo de chef/puppet y darme cabezazos..."
}
</script>
</head>
<!-- TODO : Body class -->
<body class="home-template">

<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <ul>

              <li role="presentation"><a href="https://acalustra.com/pages/about.html">About</a></li>

    </ul>
  </div>
</nav>
    <!-- Progressbar -->
    <div class="progress-container">
        <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header id="post-header" class="has-cover">
      <div class="inner">
        <nav id="navigation">
            <span id="home-button" class="nav-button">
                <a class="home-button" href="https://acalustra.com/" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
            </span>
          <span id="menu-button" class="nav-button">
            <a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
          </span>
        </nav>
        <h1 class="post-title">trick and tips en ansible</h1>
        <!-- TODO : Proper class for headline -->
        <span class="post-meta">
                <a href="https://acalustra.com/author/eloycoto.html">Eloy Coto</a>
            | <time datetime="Tuesday 03-06-2014">Tuesday 03-06-2014</time>
        </span>
        <!-- TODO : Modified check -->
            <div class="post-cover cover" style="background-image: url('https://acalustra.com/img/oia.jpg')">
      </div>
    </header>

  <section id="wrapper">
    <a class="hidden-close"></a>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
            <section class="post-content">
                <p>Hace aproximadamente dos años que empecé a trabajar con Ansible. Desde ese día después de usar algo de chef/puppet y darme cabezazos contra la pared (dada su complejidad), este stack se ha convertido en mi preferido, por lo sencillo que es. No es tan completo como los anteriormente comentados, pero para mis necesidades cumple perfectamente.</p>
<p>Durante este tiempo han sido muchas las cosas que he aprendido, de las cuales me parece bueno salientar:</p>
<p><strong>Registro de variables</strong></p>
<p>Cada tarea tiene un resultado, muchas veces creemos que no nos dan un resultado que no sea True/False. Pero muchos módulos devuelven mucha información en un objeto json. En el código fuente de los <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/library/commands/command#L150-L160">módulos se pueden buscar que info es la que exporta</a>. Para poder utilizarla solo debemos hacer lo siguiente en nuestro playbook:</p>
<pre class="literal-block">
- command: cat /etc/hostname
  register: my_var

- debug: msg=&quot;Hostname == {{my_var.stdout}} Command start at {{my_var.start}}&quot;
</pre>
<p><strong>Condicionales</strong></p>
<p>Las condiciones es una de las partes más sencillas de Ansible. Pero lo mejor que este sistema tiene es la capacidad de hacer condicionales con expresiones de python, lo que nos permite validar en una sola línea:</p>
<ul>
<li><p class="first">Usando variables internas de ansible:</p>
<pre class="literal-block">
- include: debian.yml
  when: ansible_os_family == &quot;Debian&quot;

- include: network.yml
  when: ansible_eth0.active
</pre>
</li>
<li><p class="first">Usando expresiones <a class="reference external" href="https://docs.python.org/2/library/string.html">string de python</a>:</p>
<pre class="literal-block">
- include: debian.yml
  when: &quot;'Debian' in my_var.stdout&quot;

- include: debian.yml
  when: my_var.stdout.find(&quot;Debian&quot;) =&gt;= 1

- include: debian.yml
  when: my_var.stdout.lower() == 'debian'
</pre>
</li>
</ul>
<p><strong>Debug</strong></p>
<p>Suele ser útil mostrar debug en un formato legible. La función debug es una gran desconocida pero hace justo lo que deseamos:</p>
<pre class="literal-block">
- debug: msg=&quot;System {{ inventory_hostname }} with IP: {{ansible_eth0.ipv4}} is ready&quot;
</pre>
<p><strong>pre_task y post_task</strong></p>
<p>Nosotros por ejemplo tenemos muchos roles en repositorios separados y usamos <a class="reference external" href="http://git-scm.com/docs/git-submodule">git-submodules</a>. De esta manera compartimos muchos de los roles (Asterisk, Kamailio, Postgresql) por lo que muchas veces antes de ejecutar el rol, tenemos que ejecutar una serie de tareas propias del proyecto, para ello nuestros playbooks lucen así:</p>
<pre class="literal-block">
- name: apply asterisk config
  hosts: prod
  gather_facts: yes
  user: root
  vars_files:
    - vars/prod.yml
    - vars/ha.yml
  roles:
    - asterisk
  post_task:
    - name: Add configs
      template: src=src/{{item}}.j2 dest=/etc/asterisk/{{item}}.conf mode=0444
      with_items:
        - extensions
        - sip
        - features
</pre>
<p><strong>Callbacks</strong></p>
<p>Personalmente esta es una de las funciones más interesantes que hay en <a class="reference external" href="http://jpmens.net/2012/09/11/watching-ansible-at-work-callbacks/">Ansible</a>. Cada vez que el playbook o tarea acaba podemos definir una serie de <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/plugins/callbacks/osx_say.py#L31">callbacks</a> y obtener información de la misma.Yo las suelo usar para enviar un resumen a nuestro xmpp de cuantas tareas se ejecutaron con cambios, la hora de los cambios y el resultado:</p>
<pre class="literal-block">
class CallbackModule(object):
    def playbook_on_stats(self, stats):
        do_stuff()
</pre>
<p><strong>Test</strong></p>
<p>Una de las cosas que me falta en Ansible es una solución 100% opensource como <a class="reference external" href="http://www.ansible.com/tower">Tower</a>. Tower no es caro, pero en nuestro caso, no es necesario este sistema. Una de las mejoras que hemos implementado es cada vez que se hace un push al server, Jenkins ejecuta un dry-run y ver el resultado de la siguiente manera:</p>
<pre class="literal-block">
ansible-playbook -i host playbook.yml -C
</pre>
<p>Con lo que tenemos una lista de resultados que se van a ejecutar en la máquina. En el caso de que existan cambios tengo una mini APP que nos notifica que estan pendiente cambios sin aplicar.</p>
<p>Finalmente estas son las funciones que nunca ves en los ejemplos pero que son muy útiles a la hora de desarrollar y hacer despliegues en entornos de producción, pruebas y desarrollo. Yo tengo el 90% de mis servidores basados en Ansible y cada día que pasa estoy más alegre de utilizarlo.  ;-)</p>

            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=trick and tips en ansible&amp;url=https://acalustra.com/trick-and-tips-en-ansible.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://acalustra.com/trick-and-tips-en-ansible.html" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
                    </a>
                    <a class="googleplus" href="https://plus.google.com/share?url=https://acalustra.com/trick-and-tips-en-ansible.html" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <i class="ic ic-googleplus"></i><span class="hidden">Google+</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="https://acalustra.com/tag/ansible.html">ansible</a><a href="https://acalustra.com/tag/devops.html">devops</a><a href="https://acalustra.com/tag/howto.html">howto</a><a href="https://acalustra.com/tag/asterisk.html">asterisk</a><a href="https://acalustra.com/tag/playbook.html">playbook</a>                </aside>

                <div class="clear"></div>

                <aside class="post-author">


                        <figure class="post-author-avatar">
                            <img src="https://acalustra.com/img/profile.jpg" alt="Eloy Coto" />
                        </figure>
                    <div class="post-author-bio">
                        <h4 class="post-author-name"><a href="https://acalustra.com/author/eloycoto.html">Eloy Coto</a></h4>
                            <p class="post-author-about">Senior software engineer with experience in Golang, C and Python and CI/CD</p>
                            <span class="post-author-location"><i class="ic ic-location"></i> Galicia</span>
                            <span class="post-author-website"><a href="http://acalustra.com"><i class="ic ic-link"></i> Website</a></span>
                        <!-- Social linkes in alphabet order. -->
                            <span class="post-author-github"><a target="_blank" href="https://github.com/eloycoto"><i class="ic ic-link"></i> GitHub</a></span>
                            <span class="post-author-linkedin"><a target="_blank" href="https://www.linkedin.com/in/eloycoto"><i class="ic ic-link"></i> LinkedIn</a></span>
                            <span class="post-author-twitter"><a target="_blank" href="https://twitter.com/eloycoto"><i class="ic ic-twitter"></i> Twitter</a></span>
                    </div>
                    <div class="clear"></div>
                </aside>

                </section>

                <script type="text/javascript">
                    var disqus = 'acalustra';
                    var disqus_shortname = 'acalustra';
                    var disqus_identifier = '/trick-and-tips-en-ansible.html';
                    var disqus_url = 'https://acalustra.com/trick-and-tips-en-ansible.html';
                </script>
                <noscript>Please enable JavaScript to view the comments.</noscript>
                <section class="post-comments">
                        <a id="show-disqus" class="post-comments-activate" data-disqus-identifier="/trick-and-tips-en-ansible.html" >Show Comments</a>
                    <div id="disqus_thread"></div>
                </section>

                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
      <!-- TODO : Body class -->
    <div id="body-class" style="display: none;" class=""></div>

    <footer id="footer">
      <div class="inner">
        <section class="credits">


          <span class="credits-theme">Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a></span>
          <span class="credits-software">Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a></span>
        </section>
      </div>
    </footer>
  </section>

  <script type="text/javascript" src="https://acalustra.com/theme/js/script.js"></script>

    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-36310774-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-36310774-1', { 'anonymize_ip': true });
    </script>
<script type="text/javascript">
    var disqus_shortname = 'acalustra';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>