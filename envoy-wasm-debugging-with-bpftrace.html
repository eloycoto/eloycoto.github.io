<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title> Envoy bpftrace debug</title>
    <link rel="canonical" href="https://acalustra.com/envoy-wasm-debugging-with-bpftrace.html" />
    <meta name="keywords" content=" bpf, envoy, wasm, bpftrace"/>
    <meta name="description" content=" How to debug how many proxy_wasm::export calls are made by wasm filters in envoy using BPFtrace "/>

    <link rel="stylesheet" type="text/css" href="/theme/css/style.css">
    <link rel="stylesheet" type="text/css" href="/theme/css/pygment.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://acalustra.com/rss.xml" type="application/atom+xml" rel="alternate" title="A Calustra Full Atom Feed" />







    <meta name="tags" content="bpf, envoy, wasm" />
    <meta name="date" content=" 2021-01-19 23:00:00+01:00" />
    <meta name="category" content="blog" />
    <meta name="author" content="Eloy coto" />
    <meta name="robots" content="index,follow" />
  </head>
  <body>

    <header>
      <b> A Calustra - Eloy Coto Pereiro </b>
      <a href="/">Home</a>
      <!-- <a href="/blog">Blog</a> -->
      <a href="/pages/about.html">About</a>
    </header>

<article>
  <h1 itemprop="name headline">Envoy WASM debugging with BPFtrace</h1>
  <p>
    <b rel="author">Eloy Coto Pereiro </b>
    on
    <time datetime="2021-01-19T23:00:00" itemprop="datePublished">January 19th, 2021</time>
  </p>


  <div itemprop="articleBody">
    <p>A few days back, I was checking <a class="reference external" href="https://www.envoyproxy.io/">Envoy</a>
performance when WASM is in use. <a class="reference external" href="https://github.com/envoyproxy/envoy/blob/main/bazel/PPROF.md">PPROF</a> can be enabled
quite easily in Envoy, but I wanted to have less intrusive experience.</p>
<p>In the past, to debug things like this I always use <a class="reference external" href="https://www.sourceware.org/systemtap/">Systemtap</a>, (super intrusive) but <a class="reference external" href="https://github.com/iovisor/bpftrace">BPFtrace</a> is straightforward and fast.</p>
<p>So I did this super simple <a class="reference external" href="https://github.com/eloycoto/envoy_playground/tree/master/bpftrace">docker-compose project</a> where you
can run bpftrace meanwhile you run Envoy, and here is the bpftrace script that
you can see the list of WASM functions used by Envoy, and the time that was
used.</p>
<p>Over the next weeks, I'll keep adding bpftrace scripts <a class="reference external" href="https://github.com/eloycoto/envoy_playground/tree/master/bpftrace/traces">here</a>,
because they are quite useful on my day job.</p>
<div class="highlight"><pre><span></span>#!/usr/bin/env bpftrace
BEGIN
{
  printf(&quot;Tracing proxy-wasm call in envoy...Hit Ctrl-C to end.\n&quot;);
}

uprobe:/usr/bin/envoy:proxy_wasm*exports* {
  @start[tid] = nsecs;
}

uretprobe:/usr/bin/envoy:proxy_wasm*exports*
/@start[tid]/
{
  @ns[func] = hist(nsecs - @start[tid]);
  delete(@start[tid]);
}
</pre></div>
<p>And running it using the following command:</p>
<div class="highlight"><pre><span></span>#-&gt; bpftrace -p $(pgrep envoy) /traces/proxy_wasm_calls_time.bt
Attaching 249 probes...
Tracing proxy-wasm call in envoy...Hit Ctrl-C to end.
^C
@ns[proxy_wasm::exports::get_current_time_nanoseconds(void*, proxy_wasm::Word)]:
[2K, 4K)               2 |@@@@@@@@@@@@@@@@@@@@                                |
[4K, 8K)               5 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[8K, 16K)              2 |@@@@@@@@@@@@@@@@@@@@                                |

@ns[proxy_wasm::exports::send_local_response(void*, proxy_wasm::Word, proxy_wasm::Word, proxy_wasm::Word, proxy_wasm::Word, proxy_wasm::Word, proxy_wasm::Word, proxy_wasm::Word, proxy_wasm::Word)]:
[1K, 2K)             544 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[2K, 4K)             419 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@            |
[4K, 8K)              31 |@@                                                  |
[8K, 16K)              3 |                                                    |
[16K, 32K)             1 |                                                    |
[32K, 64K)             1 |                                                    |
[64K, 128K)            1 |                                                    |

@ns[proxy_wasm::exports::send_local_response(void*, proxy_wasm::Word, proxy_wasm::Word, proxy_wasm::Word, proxy_wasm::Word, proxy_wasm::Word, proxy_wasm::Word, proxy_wasm::Word, proxy_wasm::Word)]:
[2K, 4K)             653 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[4K, 8K)             295 |@@@@@@@@@@@@@@@@@@@@@@@                             |
[8K, 16K)             47 |@@@                                                 |
[16K, 32K)             5 |                                                    |

@ns[proxy_wasm::exports::get_header_map_pairs(void*, proxy_wasm::Word, proxy_wasm::Word, proxy_wasm::Word)]:
[1K, 2K)             295 |@@@@@@@@@@@@@@@@@@@@@@@                             |
[2K, 4K)             653 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[4K, 8K)              47 |@@@                                                 |
[8K, 16K)              3 |                                                    |
[16K, 32K)             2 |                                                    |

@ns[proxy_wasm::exports::log(void*, proxy_wasm::Word, proxy_wasm::Word, proxy_wasm::Word)]:
[1K, 2K)            4036 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ |
[2K, 4K)            4098 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[4K, 8K)             746 |@@@@@@@@@                                           |
[8K, 16K)            106 |@                                                   |
[16K, 32K)            14 |                                                    |
[32K, 64K)             6 |                                                    |
[64K, 128K)            1 |                                                    |
[128K, 256K)           1 |                                                    |
[256K, 512K)           0 |                                                    |
[512K, 1M)             0 |                                                    |
[1M, 2M)               1 |                                                    |
</pre></div>
<p>If you want to learn bpftrace, I highly recommend to have a look at <a class="reference external" href="https://github.com/iovisor/bpftrace/blob/master/docs/tutorial_one_liners.md">bpftrace
one-liners</a>
tutorial, is made for dummies like me.</p>
<p>Enjoy!</p>


    <h3>Tags</h3>
    <div class="taglist">
        <span class="tag">
          <a href="/tag/bpf.html" rel="tag">bpf</a>
        </span>
        <span class="tag">
          <a href="/tag/envoy.html" rel="tag">envoy</a>
        </span>
        <span class="tag">
          <a href="/tag/wasm.html" rel="tag">wasm</a>
        </span>
    </div><!--tags-->

    <h4>Related articles:</h4>

  </div>
</article></body>