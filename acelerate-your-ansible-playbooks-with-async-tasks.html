<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


  <title>Acelerate your Ansible playbooks with async tasks</title>


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
  <link href="https://acalustra.com/" rel="canonical" />

  <!-- Feed -->
        <link href="https://acalustra.com/rss.xml" type="application/atom+xml" rel="alternate" title="A Calustra Full Atom Feed" />

  <link href="https://acalustra.com/theme/css/style.css" type="text/css" rel="stylesheet" />

  <!-- Code highlight color scheme -->
      <link href="https://acalustra.com/theme/css/code_blocks/monokai.css" rel="stylesheet">

    <!-- CSS specified by the user -->


    <link href="https://acalustra.com/theme/css/eloy.css" type="text/css" rel="stylesheet" />

  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->


  <link href="https://acalustra.com/acelerate-your-ansible-playbooks-with-async-tasks.html" rel="canonical" />
  <meta name="keywords" content="ansible, async, playbooks, devops" >

    <meta name="description" content="I'm always impressed with my friends of Streetlife. They built a new infrastructure based on immutable deploys. I'm surprised about how...">

    <meta name="author" content="eloycoto">

    <meta name="tags" content="ansible">
    <meta name="tags" content="async">
    <meta name="tags" content="debian">
    <meta name="tags" content="devops">
    <meta name="tags" content="deploy">




<!-- Open Graph -->
<meta property="og:site_name" content="A Calustra"/>
<meta property="og:title" content="Acelerate your Ansible playbooks with async tasks"/>
<meta property="og:description" content="I'm always impressed with my friends of Streetlife. They built a new infrastructure based on immutable deploys. I'm surprised about how..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://acalustra.com/acelerate-your-ansible-playbooks-with-async-tasks.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2015-05-08 16:00:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://acalustra.com/author/eloycoto.html">
<meta property="article:section" content="blog"/>
<meta property="article:tag" content="ansible"/>
<meta property="article:tag" content="async"/>
<meta property="article:tag" content="debian"/>
<meta property="article:tag" content="devops"/>
<meta property="article:tag" content="deploy"/>
<meta property="og:image" content="https://acalustra.com/img/oia.jpg">

<!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@eloycoto">
    <meta name="twitter:title" content="Acelerate your Ansible playbooks with async tasks">
    <meta name="twitter:url" content="https://acalustra.com/acelerate-your-ansible-playbooks-with-async-tasks.html">

        <meta name="twitter:image:src" content="https://acalustra.com/img/oia.jpg">

      <meta name="twitter:description" content="I'm always impressed with my friends of Streetlife. They built a new infrastructure based on immutable deploys. I'm surprised about how...">

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Acelerate your Ansible playbooks with async tasks",
  "headline": "Acelerate your Ansible playbooks with async tasks",
  "datePublished": "2015-05-08 16:00:00+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "eloycoto",
    "url": "https://acalustra.com/author/eloycoto.html"
  },
  "image": "https://acalustra.com/img/oia.jpg",
  "url": "https://acalustra.com/acelerate-your-ansible-playbooks-with-async-tasks.html",
  "description": "I'm always impressed with my friends of Streetlife. They built a new infrastructure based on immutable deploys. I'm surprised about how..."
}
</script>
</head>
<!-- TODO : Body class -->
<body class="home-template">

<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <ul>

              <li role="presentation"><a href="https://acalustra.com/pages/about.html">About</a></li>

    </ul>
  </div>
</nav>
    <!-- Progressbar -->
    <div class="progress-container">
        <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header id="post-header" class="has-cover">
      <div class="inner">
        <nav id="navigation">
            <span id="home-button" class="nav-button">
                <a class="home-button" href="https://acalustra.com/" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
            </span>
          <span id="menu-button" class="nav-button">
            <a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
          </span>
        </nav>
        <h1 class="post-title">Acelerate your Ansible playbooks with async tasks</h1>
        <!-- TODO : Proper class for headline -->
        <span class="post-meta">
                <a href="https://acalustra.com/author/eloycoto.html">Eloy Coto</a>
            | <time datetime="Friday 08-05-2015">Friday 08-05-2015</time>
        </span>
        <!-- TODO : Modified check -->
            <div class="post-cover cover" style="background-image: url('https://acalustra.com/img/oia.jpg')">
      </div>
    </header>

  <section id="wrapper">
    <a class="hidden-close"></a>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
            <section class="post-content">
                <p>I'm always impressed with my friends of
<a class="reference external" href="https://www.streetlife.com/about/team/">Streetlife</a>. They built a new
infrastructure based on immutable deploys. I'm surprised about how fast they are
able to build this
<a class="reference external" href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">AMIs</a>, they can
start a new full configured server in only 6 min.</p>
<p>Three years ago I've started using <a class="reference external" href="http://docs.ansible.com/">Ansible</a>. My
deploys <strong>were</strong> always up to twenty minutes, so one day I decided to achieve an
eight-min deploy. Eight min will be the time that I have to build a new server.</p>
<p>To get this eight minute build, I focused on the following tasks:</p>
<div class="section" id="apt-cache-time">
<h2>APT cache time:</h2>
<p>When you have different roles in Ansible, usually you always set <em>update_cache</em>
in the apt task. This is pretty useful, but painful with different roles.</p>
<p>Ansible provides the
<a class="reference external" href="http://docs.ansible.com/apt_module.html">cache_valid_time</a> option. If you
enable it, Ansible will check the cache age. If cache age is less than your
value, apt-get update will be ignored.</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Installing useful packages</span>
  <span class="nt">apt</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="nt">update_cache</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class="nt">cache_valid_time</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3600</span>
  <span class="nt">with_items</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">htop</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ngrep</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">vim</span>
</pre></div>
</div>
<div class="section" id="async-tasks">
<h2>Async Tasks:</h2>
<p>Async tasks are in Ansible from version 1.7. It works like this: while one long
task is running, another short task can be executed.</p>
<p>For example, if you want to install pip dependencies and bower dependencies:
both are needed, both can run at the same time and both take few minutes.</p>
<p>With async tasks, tasks can be executed and forget, but this background task
can be checked later. So Ansible provides the option to get the task status in
any time.</p>
<p>The following example show how pip and bower dependencies will run in two new
coroutines. While the dependencies are being installed in the system, another
task will create the users (or any other task). Before the playbook is
finished, it's going to be checked if the coroutines has finished properly.</p>
<div class="highlight"><pre><span></span>- name: bower install requirements (Coroutine #2)
  bower:
    path: /my_app/frontend/
    state: latest
  async: 1000
  poll: 0
  register: bower_install

- name: Add the users in the platform
  user:
    name: &quot;{{item.name}}&quot;
    shell: /bin/bash
    groups: &quot;{{item.groups}}&quot;
    state: &quot;{{item.status}}&quot;
  with_items:
    - {name: eloy, state: present, groups: admin}
    - {name: www, state: present, groups: admin}
    - {name: ftp, state: present, groups: admin}

- name: PIP result check (Check coroutine #1)
  async_status:
    jid: &quot;{{ pip_install.ansible_job_id }}&quot;
  register: job_result
  until: job_result.finished
  retries: 30

- name: Bower result check (Check coroutine #2)
  async_status:
    jid: &quot;{{ bower_install.ansible_job_id }}&quot;
  register: job_result
  until: job_result.finished
  retries: 30
</pre></div>
</div>
<div class="section" id="ansible-async-task-and-loops">
<h2>Ansible async task and loops:</h2>
<p>When you start with Ansible, you use a lot of <em>with_items</em>. Loops are not
supported in Async tasks, but the following workaround can be used:</p>
<div class="highlight"><pre><span></span><span class="c1"># vars.yml</span>
<span class="nt">dependencies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">bison</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">gcc</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">git</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">make</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mercurial</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Installing dependencies</span>
  <span class="nt">apt</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">&#39;,&#39;.join(dependencies)</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="nt">update_cache</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class="nt">cache_valid_time</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3600</span>
  <span class="nt">async</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1000</span>
  <span class="nt">poll</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
</pre></div>
<p>Happy deploy!</p>
</div>

            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=Acelerate your Ansible playbooks with async tasks&amp;url=https://acalustra.com/acelerate-your-ansible-playbooks-with-async-tasks.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://acalustra.com/acelerate-your-ansible-playbooks-with-async-tasks.html" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
                    </a>
                    <a class="googleplus" href="https://plus.google.com/share?url=https://acalustra.com/acelerate-your-ansible-playbooks-with-async-tasks.html" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <i class="ic ic-googleplus"></i><span class="hidden">Google+</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="https://acalustra.com/tag/ansible.html">ansible</a><a href="https://acalustra.com/tag/async.html">async</a><a href="https://acalustra.com/tag/debian.html">debian</a><a href="https://acalustra.com/tag/devops.html">devops</a><a href="https://acalustra.com/tag/deploy.html">deploy</a>                </aside>

                <div class="clear"></div>

                <aside class="post-author">


                        <figure class="post-author-avatar">
                            <img src="https://acalustra.com/img/profile.jpg" alt="Eloy Coto" />
                        </figure>
                    <div class="post-author-bio">
                        <h4 class="post-author-name"><a href="https://acalustra.com/author/eloycoto.html">Eloy Coto</a></h4>
                            <p class="post-author-about">Senior software engineer with experience in Golang, C and Python and CI/CD</p>
                            <span class="post-author-location"><i class="ic ic-location"></i> Galicia</span>
                            <span class="post-author-website"><a href="http://acalustra.com"><i class="ic ic-link"></i> Website</a></span>
                        <!-- Social linkes in alphabet order. -->
                            <span class="post-author-github"><a target="_blank" href="https://github.com/eloycoto"><i class="ic ic-link"></i> GitHub</a></span>
                            <span class="post-author-linkedin"><a target="_blank" href="https://www.linkedin.com/in/eloycoto"><i class="ic ic-link"></i> LinkedIn</a></span>
                            <span class="post-author-twitter"><a target="_blank" href="https://twitter.com/eloycoto"><i class="ic ic-twitter"></i> Twitter</a></span>
                    </div>
                    <div class="clear"></div>
                </aside>

                </section>

                <script type="text/javascript">
                    var disqus = 'acalustra';
                    var disqus_shortname = 'acalustra';
                    var disqus_identifier = '/acelerate-your-ansible-playbooks-with-async-tasks.html';
                    var disqus_url = 'https://acalustra.com/acelerate-your-ansible-playbooks-with-async-tasks.html';
                </script>
                <noscript>Please enable JavaScript to view the comments.</noscript>
                <section class="post-comments">
                        <a id="show-disqus" class="post-comments-activate" data-disqus-identifier="/acelerate-your-ansible-playbooks-with-async-tasks.html" >Show Comments</a>
                    <div id="disqus_thread"></div>
                </section>

                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
      <!-- TODO : Body class -->
    <div id="body-class" style="display: none;" class=""></div>

    <footer id="footer">
      <div class="inner">
        <section class="credits">


          <span class="credits-theme">Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a></span>
          <span class="credits-software">Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a></span>
        </section>
      </div>
    </footer>
  </section>

  <script type="text/javascript" src="https://acalustra.com/theme/js/script.js"></script>

    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-36310774-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-36310774-1', { 'anonymize_ip': true });
    </script>
<script type="text/javascript">
    var disqus_shortname = 'acalustra';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>