<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta charset="UTF-8">
    <meta http-equiv="content-language" content="es">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title> How to accelerate your Ansible Playbooks</title>
    <link rel="canonical" href="http://www.acalustra.com/acelerate-your-ansible-playbooks-with-async-tasks.html" />
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <meta name="keywords" content=" ansible, async, playbooks, devops"/>
    <meta name="description" content=" With Async tasks in Ansible you can run actions in background while short task are running, so you can speed-up your deploy. "/>

    <link rel="stylesheet" type="text/css" href="/theme/css/style.css">
    <link rel="stylesheet" type="text/css" href="/theme/css/pygment.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="http://www.acalustra.com/rss.xml" type="application/atom+xml" rel="alternate" title="A calustra Full Atom Feed" />







    <meta name="tags" content="ansible, ansible playbooks, ansible async, ansible async with_items" />
    <meta name="date" content=" 2015-05-08 16:00:00+02:00" />
    <meta name="category" content="blog" />
    <meta name="author" content="Eloy coto" />
    <meta name="robots" content="index,follow" />
  </head>
  <body>
  <div class="wrapper">
    <div class="row nav">
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="archives.html">Blog</a></li>
      </ul>
    </div><!--row nav-->

    <div class="container content">
<div class="row">

  <div id="blog_post" class="blog" itemscope="" itemprop="blogPost" itemtype="http://schema.org/BlogPosting">
    <div class="col-9 col-offset-1">
      <h1 itemprop="name headline">Speed up your Ansible Playbooks</h1>
      <div class="byline">
        Escrito por:
        <span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <span itemprop="name">
            <a href="https://plus.google.com/106179242242173415236/posts" itemprop="url" rel="author">Eloy Coto Pereiro</a>
          </span>
        </span>
        on
        <time datetime="2015-05-08T16:00:00" itemprop="datePublished">Friday May 08th 2015</time>
      </div>

      <div class="content" itemprop="articleBody">
        <p>I'm always impressed with my friends of
<a class="reference external" href="https://www.streetlife.com/about/team/">Streetlife</a>. They built a new
infrastructure based on immutable deploys. I'm surprised about how fast they are
able to build this
<a class="reference external" href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">AMIs</a>, they can
start a new full configured server in only 6 min.</p>
<p>Three years ago I've started using <a class="reference external" href="http://docs.ansible.com/">Ansible</a>. My
deploys <strong>were</strong> always up to twenty minutes, so one day I decided to achieve an
eight-min deploy. Eight min will be the time that I have to build a new server.</p>
<p>To get this eight minute build, I focused on the following tasks:</p>
<div class="section" id="apt-cache-time">
<h2>APT cache time:</h2>
<p>When you have different roles in Ansible, usually you always set <em>update_cache</em>
in the apt task. This is pretty useful, but painful with different roles.</p>
<p>Ansible provides the
<a class="reference external" href="http://docs.ansible.com/apt_module.html">cache_valid_time</a> option. If you
enable it, Ansible will check the cache age. If cache age is less than your
value, apt-get update will be ignored.</p>
<div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Installing useful packages</span>
  <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="l-Scalar-Plain">update_cache</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
    <span class="l-Scalar-Plain">cache_valid_time</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3600</span>
  <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">htop</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ngrep</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">vim</span>
</pre></div>
</div>
<div class="section" id="async-tasks">
<h2>Async Tasks:</h2>
<p>Async tasks are in Ansible from version 1.7. It works like this: while one long
task is running, another short task can be executed.</p>
<p>For example, if you want to install pip dependencies and bower dependencies:
both are needed, both can run at the same time and both take few minutes.</p>
<p>With async tasks, tasks can be executed and forget, but this background task
can be checked later. So Ansible provides the option to get the task status in
any time.</p>
<p>The following example show how pip and bower dependencies will run in two new
coroutines. While the dependencies are being installed in the system, another
task will create the users (or any other task). Before the playbook is
finished, it's going to be checked if the coroutines has finished properly.</p>
<div class="highlight"><pre>- name: bower install requirements (Coroutine #2)
  bower:
    path: /my_app/frontend/
    state: latest
  async: 1000
  poll: 0
  register: bower_install

- name: Add the users in the platform
  user:
    name: &quot;{{item.name}}&quot;
    shell: /bin/bash
    groups: &quot;{{item.groups}}&quot;
    state: &quot;{{item.status}}&quot;
  with_items:
    - {name: eloy, state: present, groups: admin}
    - {name: www, state: present, groups: admin}
    - {name: ftp, state: present, groups: admin}

- name: PIP result check (Check coroutine #1)
  async_status:
    jid: &quot;{{ pip_install.ansible_job_id }}&quot;
  register: job_result
  until: job_result.finished
  retries: 30

- name: Bower result check (Check coroutine #2)
  async_status:
    jid: &quot;{{ bower_install.ansible_job_id }}&quot;
  register: job_result
  until: job_result.finished
  retries: 30
</pre></div>
</div>
<div class="section" id="ansible-async-task-and-loops">
<h2>Ansible async task and loops:</h2>
<p>When you start with Ansible, you use a lot of <em>with_items</em>. Loops are not
supported in Async tasks, but the following workaround can be used:</p>
<div class="highlight"><pre><span class="c1"># vars.yml</span>
<span class="l-Scalar-Plain">dependencies</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">bison</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">gcc</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">git</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">make</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mercurial</span>
</pre></div>
<div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Installing dependencies</span>
  <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">&#39;</span><span class="nv"> </span><span class="s">&#39;.join(dependencies)</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="l-Scalar-Plain">update_cache</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
    <span class="l-Scalar-Plain">cache_valid_time</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3600</span>
  <span class="l-Scalar-Plain">async</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1000</span>
  <span class="l-Scalar-Plain">poll</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</pre></div>
<p>This playbook will not work in Ansible Trunk version. <a class="reference external" href="https://github.com/ansible/ansible-modules-core/pull/1255">I sent a new PR to enable</a> multiple packages
inline.</p>
<p>Happy deploy!</p>
</div>

      </div>

      <p style="display:none" itemprop="keywords"> ansible, async, debian, deploy, devops,  </p>

        <div class="comments">
          <h4>Commentarios:</h4>
          <div id="disqus_thread"></div>
            <script type="text/javascript" src="http://acalustra.disqus.com/embed.js"></script>
            <noscript><a href="http://acalustra.disqus.com/?url=ref">Ver el hilo de discusión</a></noscript>
        </div> <!-- .comments-container -->

      <div class="row">
        <h4>Artículos relacionados:</h4>
            <ul>
                <li><a href="http://www.acalustra.com/ansible-how-to-maintain-multiple-ssh-keys-in-different-servers.html">Ansible: how to maintain multiple ssh-keys in different servers</a></li>
                <li><a href="http://www.acalustra.com/trick-and-tips-en-ansible.html">trick and tips en ansible</a></li>
            </ul>
      </div>


    </div>
    <div class="col-2">
      <h3>Tags</h3>
      <div class="tags">
          <span class="tag">
            <a href="http://www.acalustra.com/tag/ansible.html" rel="tag">ansible</a>
          </span>
          <span class="tag">
            <a href="http://www.acalustra.com/tag/async.html" rel="tag">async</a>
          </span>
          <span class="tag">
            <a href="http://www.acalustra.com/tag/debian.html" rel="tag">debian</a>
          </span>
          <span class="tag">
            <a href="http://www.acalustra.com/tag/deploy.html" rel="tag">deploy</a>
          </span>
          <span class="tag">
            <a href="http://www.acalustra.com/tag/devops.html" rel="tag">devops</a>
          </span>
      </div><!--tags-->
      <div class="share">
        <a href="http://twitter.com/share?text=Acelerate your Ansible playbooks with async tasks via @eloycoto&url=http://www.acalustra.com/acelerate-your-ansible-playbooks-with-async-tasks.html"><i class="fa fa-twitter"></i></a>
        <br>
        <a href="http://www.facebook.com/sharer/sharer.php?u=http://www.acalustra.com/acelerate-your-ansible-playbooks-with-async-tasks.html"><i class="fa fa-facebook"></i></a>
        <br>
        <a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&url=http://www.acalustra.com/acelerate-your-ansible-playbooks-with-async-tasks.html&title=Acelerate your Ansible playbooks with async tasks"><i class="fa fa-linkedin"></i></a>
      </div>
    </div>
  </div>
</div>    </div><!--container-->

    <div class="row footer">
      <div class="container">
        <div class="col-3">
          <p>Eloy Coto</p>
        </div>

        <div class="col-3 col-offset-3">
          <p> Contact: eloy.coto@gmail.com</p>
        </div>

      </div>
    </div>
  </div><!--wrapper-->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-36310774-1', 'auto');
    ga('send', 'pageview');

  </script>
  </body>
</html>